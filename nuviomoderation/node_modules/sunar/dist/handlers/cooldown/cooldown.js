import { __name } from '../../chunk-7QVYU63E.js';
import { Collection } from 'discord.js';
import { cooldownManager, context } from '../../stores/index.js';
import { resolveCooldown, CooldownScope } from '../../utils/index.js';

function handleCooldown(interaction, builder) {
  if (!builder.config.cooldown) return false;
  if (!interaction.isRepliable()) return false;
  const config = resolveCooldown(builder.config.cooldown);
  const { scope } = config;
  const isUser = scope === CooldownScope.User;
  const isChannel = scope === CooldownScope.Channel;
  const isGuild = scope === CooldownScope.Guild;
  const isGlobal = scope === CooldownScope.Global;
  const targetId = isUser ? interaction.user.id : isChannel ? interaction.channelId : isGuild ? interaction.guildId : isGlobal ? Symbol() : null;
  if (targetId === null) return false;
  if (!isGlobal && config.exclude.includes(targetId)) return false;
  const scopes = cooldownManager.ensure(builder.type, () => new Collection());
  const interactionId = getInteractionId(interaction);
  if (!interactionId) return false;
  const cooldowns = scopes.ensure(scope, () => new Collection([[interactionId, []]]));
  const timestamps = cooldowns.ensure(interactionId, () => []);
  const targetTimestamps = timestamps.filter(
    (c) => typeof c.targetId === "symbol" ? c.targetId === targetId : c.targetId.startsWith(String(targetId))
  );
  if (!targetTimestamps || targetTimestamps.length < config.limit) {
    addCooldown(targetId, config.time, interactionId, cooldowns, timestamps, targetTimestamps);
    return false;
  }
  const lastTimestamp = targetTimestamps.at(-1);
  if (!lastTimestamp) return false;
  const remaining = config.time - (Date.now() - lastTimestamp.expiration);
  context.client.emit("cooldown", interaction, { remaining, scope, limit: config.limit });
  return true;
}
__name(handleCooldown, "handleCooldown");
function addCooldown(targetId, time, interactionId, cooldownManager2, currentTimestamps, targetTimestamps) {
  const timer = setTimeout(() => {
    cooldownManager2.sweep((t) => t.some((c) => c.targetId === uniqueId));
  }, time);
  const uniqueId = `${String(targetId)}-${Date.now().toString(36)}`;
  const newTimestamp = { targetId: uniqueId, expiration: Date.now(), timer };
  cooldownManager2.set(interactionId, currentTimestamps ? [...currentTimestamps, newTimestamp] : [newTimestamp]);
  for (const { timer: timer2 } of targetTimestamps) {
    timer2.refresh();
  }
}
__name(addCooldown, "addCooldown");
function getInteractionId(interaction) {
  if (interaction.isCommand()) return interaction.commandId;
  if (interaction.isMessageComponent()) return interaction.customId;
  return null;
}
__name(getInteractionId, "getInteractionId");

export { handleCooldown };
//# sourceMappingURL=cooldown.js.map
//# sourceMappingURL=cooldown.js.map